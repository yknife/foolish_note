### 函数说明

[LanguageManual+WindowingAndAnalytics](https://cwiki.apache.org/confluence/display/Hive/LanguageManual+WindowingAndAnalytics)

OVER()：指定分析函数工作的数据窗口大小，这个数据窗口大小可能会随着行的变而变化。

* CURRENT ROW：当前行 
* n PRECEDING：往前 n 行数据 
* n FOLLOWING：往后 n 行数据 
* UNBOUNDED：起点， 
  * UNBOUNDED PRECEDING 表示从前面的起点， 
  * UNBOUNDED FOLLOWING 表示到后面的终点 
* LAG(col,n,default_val)：往前第 n 行数据 
* LEAD(col,n, default_val)：往后第 n 行数据 
* NTILE(n)：把有序窗口的行分发到指定数据的组中，各个组有编号，编号从 1 开始，对 于每一行，NTILE 返回此行所属的组的编号。注意：n 必须为 int 类型。

### 数据准备

```sql
jack,2017-01-01,10
tony,2017-01-02,15
jack,2017-02-03,23
tony,2017-01-04,29
jack,2017-01-05,46
jack,2017-04-06,42
tony,2017-01-07,50
jack,2017-01-08,55
mart,2017-04-08,62
mart,2017-04-09,68
neil,2017-05-10,12
mart,2017-04-11,75
neil,2017-06-12,80
mart,2017-04-13,94
```

### 建表并导入数据

```sql
create table business(
name string,
orderdate string,
cost int
) ROW FORMAT DELIMITED FIELDS TERMINATED BY ',';
load data local inpath "/opt/module/data/business.txt" into table
business;
```

### 按需求查询

1. 查询在 2017 年 4 月份购买过的顾客及总人数

   ```sql
   select 
    name,
    -- over()表示对group by的所有结果开窗，如果希望部分开窗，可以通过传参的方式部分开窗
    count(*) over()
   from business
   where substring(orderdate,0,7)='2017-04'
   group by name
   
   +-------+-----------------+
   | name  | count_window_0  |
   +-------+-----------------+
   | mart  | 2               |
   | jack  | 2               |
   +-------+-----------------+
   ```

2. 查询顾客的购买明细及月购买总额

   ```sql
   select
    name,orderdate,cost,sum(cost) over(partition by month(orderdate))
   from business
   
   +-------+-------------+-------+---------------+
   | name  |  orderdate  | cost  | sum_window_0  |
   +-------+-------------+-------+---------------+
   | jack  | 2017-01-01  | 10    | 205           |
   | jack  | 2017-01-08  | 55    | 205           |
   | tony  | 2017-01-07  | 50    | 205           |
   | jack  | 2017-01-05  | 46    | 205           |
   | tony  | 2017-01-04  | 29    | 205           |
   | tony  | 2017-01-02  | 15    | 205           |
   | jack  | 2017-02-03  | 23    | 23            |
   | mart  | 2017-04-13  | 94    | 341           |
   | jack  | 2017-04-06  | 42    | 341           |
   | mart  | 2017-04-11  | 75    | 341           |
   | mart  | 2017-04-09  | 68    | 341           |
   | mart  | 2017-04-08  | 62    | 341           |
   | neil  | 2017-05-10  | 12    | 12            |
   | neil  | 2017-06-12  | 80    | 80            |
   +-------+-------------+-------+---------------+
   -- 查询顾客的购买明细及顾客的月购买总额
   select
    name,orderdate,cost,sum(cost) over(partition by name,month(orderdate))
   from business
   
   +-------+-------------+-------+---------------+
   | name  |  orderdate  | cost  | sum_window_0  |
   +-------+-------------+-------+---------------+
   | jack  | 2017-01-05  | 46    | 111           |
   | jack  | 2017-01-08  | 55    | 111           |
   | jack  | 2017-01-01  | 10    | 111           |
   | jack  | 2017-02-03  | 23    | 23            |
   | jack  | 2017-04-06  | 42    | 42            |
   | mart  | 2017-04-13  | 94    | 299           |
   | mart  | 2017-04-11  | 75    | 299           |
   | mart  | 2017-04-09  | 68    | 299           |
   | mart  | 2017-04-08  | 62    | 299           |
   | neil  | 2017-05-10  | 12    | 12            |
   | neil  | 2017-06-12  | 80    | 80            |
   | tony  | 2017-01-04  | 29    | 94            |
   | tony  | 2017-01-02  | 15    | 94            |
   | tony  | 2017-01-07  | 50    | 94            |
   +-------+-------------+-------+---------------+
   ```

3. 将每个顾客的 cost 按照日期进行累加

   ```sql
   -- 官方文档
   -- When ORDER BY is specified with missing WINDOW clause, the WINDOW specification defaults to RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW.
   select
    name,orderdate,cost,sum(cost) over(partition by name order by orderdate)
   from business
   +-------+-------------+-------+---------------+
   | name  |  orderdate  | cost  | sum_window_0  |
   +-------+-------------+-------+---------------+
   | jack  | 2017-01-01  | 10    | 10            |
   | jack  | 2017-01-05  | 46    | 56            |
   | jack  | 2017-01-08  | 55    | 111           |
   | jack  | 2017-02-03  | 23    | 134           |
   | jack  | 2017-04-06  | 42    | 176           |
   | mart  | 2017-04-08  | 62    | 62            |
   | mart  | 2017-04-09  | 68    | 130           |
   | mart  | 2017-04-11  | 75    | 205           |
   | mart  | 2017-04-13  | 94    | 299           |
   | neil  | 2017-05-10  | 12    | 12            |
   | neil  | 2017-06-12  | 80    | 92            |
   | tony  | 2017-01-02  | 15    | 15            |
   | tony  | 2017-01-04  | 29    | 44            |
   | tony  | 2017-01-07  | 50    | 94            |
   +-------+-------------+-------+---------------+
   -- 等效与
   select
    name,orderdate,cost,sum(cost) over(partition by name order by orderdate rows BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)
   from business
   +-------+-------------+-------+---------------+
   | name  |  orderdate  | cost  | sum_window_0  |
   +-------+-------------+-------+---------------+
   | jack  | 2017-01-01  | 10    | 10            |
   | jack  | 2017-01-05  | 46    | 56            |
   | jack  | 2017-01-08  | 55    | 111           |
   | jack  | 2017-02-03  | 23    | 134           |
   | jack  | 2017-04-06  | 42    | 176           |
   | mart  | 2017-04-08  | 62    | 62            |
   | mart  | 2017-04-09  | 68    | 130           |
   | mart  | 2017-04-11  | 75    | 205           |
   | mart  | 2017-04-13  | 94    | 299           |
   | neil  | 2017-05-10  | 12    | 12            |
   | neil  | 2017-06-12  | 80    | 92            |
   | tony  | 2017-01-02  | 15    | 15            |
   | tony  | 2017-01-04  | 29    | 44            |
   | tony  | 2017-01-07  | 50    | 94            |
   +-------+-------------+-------+---------------+
   -- 开窗相邻的行
   select
    name,orderdate,cost,sum(cost) over(partition by name order by orderdate rows BETWEEN 1 PRECEDING AND 1 FOLLOWING)
   from business
   +-------+-------------+-------+---------------+
   | name  |  orderdate  | cost  | sum_window_0  |
   +-------+-------------+-------+---------------+
   | jack  | 2017-01-01  | 10    | 56            |
   | jack  | 2017-01-05  | 46    | 111           |
   | jack  | 2017-01-08  | 55    | 124           |
   | jack  | 2017-02-03  | 23    | 120           |
   | jack  | 2017-04-06  | 42    | 65            |
   | mart  | 2017-04-08  | 62    | 130           |
   | mart  | 2017-04-09  | 68    | 205           |
   | mart  | 2017-04-11  | 75    | 237           |
   | mart  | 2017-04-13  | 94    | 169           |
   | neil  | 2017-05-10  | 12    | 92            |
   | neil  | 2017-06-12  | 80    | 92            |
   | tony  | 2017-01-02  | 15    | 44            |
   | tony  | 2017-01-04  | 29    | 94            |
   | tony  | 2017-01-07  | 50    | 79            |
   +-------+-------------+-------+---------------+
   -- 开窗从第一行到当前行的上一行
   select
    name,orderdate,cost,sum(cost) over(partition by name order by orderdate rows BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING)
   from business
   +-------+-------------+-------+---------------+
   | name  |  orderdate  | cost  | sum_window_0  |
   +-------+-------------+-------+---------------+
   | jack  | 2017-01-01  | 10    | NULL          |
   | jack  | 2017-01-05  | 46    | 10            |
   | jack  | 2017-01-08  | 55    | 56            |
   | jack  | 2017-02-03  | 23    | 111           |
   | jack  | 2017-04-06  | 42    | 134           |
   | mart  | 2017-04-08  | 62    | NULL          |
   | mart  | 2017-04-09  | 68    | 62            |
   | mart  | 2017-04-11  | 75    | 130           |
   | mart  | 2017-04-13  | 94    | 205           |
   | neil  | 2017-05-10  | 12    | NULL          |
   | neil  | 2017-06-12  | 80    | 12            |
   | tony  | 2017-01-02  | 15    | NULL          |
   | tony  | 2017-01-04  | 29    | 15            |
   | tony  | 2017-01-07  | 50    | 44            |
   +-------+-------------+-------+---------------+
   -- 所有查询结果按照时间顺序依次累加
   select
    name,orderdate,cost,sum(cost) over(order by orderdate)
   from business
   +-------+-------------+-------+---------------+
   | name  |  orderdate  | cost  | sum_window_0  |
   +-------+-------------+-------+---------------+
   | jack  | 2017-01-01  | 10    | 10            |
   | tony  | 2017-01-02  | 15    | 25            |
   | tony  | 2017-01-04  | 29    | 54            |
   | jack  | 2017-01-05  | 46    | 100           |
   | tony  | 2017-01-07  | 50    | 150           |
   | jack  | 2017-01-08  | 55    | 205           |
   | jack  | 2017-02-03  | 23    | 228           |
   | jack  | 2017-04-06  | 42    | 270           |
   | mart  | 2017-04-08  | 62    | 332           |
   | mart  | 2017-04-09  | 68    | 400           |
   | mart  | 2017-04-11  | 75    | 475           |
   | mart  | 2017-04-13  | 94    | 569           |
   | neil  | 2017-05-10  | 12    | 581           |
   | neil  | 2017-06-12  | 80    | 661           |
   +-------+-------------+-------+---------------+
   ```

   





